<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Job Network Visualization</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        #root {
            height: 100%;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .node-label {
            font-size: 8px;
            pointer-events: none;
        }
        /* Scrollable container for job details */
        .details-container {
            max-height: 600px;
            overflow-y: auto;
        }
        /* Tag style for attributes */
        .attribute-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <!-- Virtual file system for the React component -->
    <script>
        // Create a virtual file system that fetches the Excel file directly
        window.fs = {
            readFile: async (filename, options = {}) => {
                // If it's our Excel file
                if (filename === 'job Opp_10.xlsx') {
                    try {
                        // Fetch the file directly from the repository
                        const response = await fetch('job Opp_10.xlsx');
                        const arrayBuffer = await response.arrayBuffer();
                        
                        // If encoding is specified, return as string
                        if (options.encoding === 'utf8') {
                            const decoder = new TextDecoder('utf-8');
                            return decoder.decode(new Uint8Array(arrayBuffer));
                        }
                        
                        // Otherwise return as ArrayBuffer
                        return arrayBuffer;
                    } catch (error) {
                        console.error("Error fetching Excel file:", error);
                        throw error;
                    }
                }
                
                throw new Error(`File ${filename} not found`);
            }
        };
    </script>

    <!-- Main Application Code -->
    <script type="text/babel">
        const JobNetworkVisualization = () => {
            // States
            const [data, setData] = React.useState(null);
            const [nodes, setNodes] = React.useState([]);
            const [links, setLinks] = React.useState([]);
            const [selectedCategories, setSelectedCategories] = React.useState({
                strength: true,
                interest: true,
                education: true
            });
            const [selectedJobDetails, setSelectedJobDetails] = React.useState(null);
            const [expandedSections, setExpandedSections] = React.useState({
                workMode: true,
                salary: true,
                strengths: true,
                interests: true,
                education: true,
                sourceLinks: true
            });
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            
            // Refs
            const svgRef = React.useRef(null);
            const simulationRef = React.useRef(null);
            
            // Constants for visualization
            const width = 800;
            const height = 600;
            const nodeRadius = 6;
            
            // Fetch and process data
            React.useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        const fileData = await window.fs.readFile('job Opp_10.xlsx');
                        const workbook = XLSX.read(fileData, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        setData(jsonData);
                        processData(jsonData);
                        setLoading(false);
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setError('Failed to load data. Please try again.');
                        setLoading(false);
                    }
                };
                
                fetchData();
            }, []);
            
            // Process data to create nodes and links
            const processData = (jsonData) => {
                if (!jsonData || jsonData.length === 0) return;
                
                // Extract unique values for each category
                const uniqueStrengths = [...new Set(jsonData.map(item => item.Strength))];
                const uniqueInterests = [...new Set(jsonData.map(item => item["Interest/Hobby"]))];
                const uniqueEducation = [...new Set(jsonData.map(item => item["Educational Background"]))];
                const uniqueJobs = [...new Set(jsonData.map(item => item["Job Opportunity"]))];
                
                // Create nodes array
                const nodesArray = [
                    ...uniqueStrengths.map(item => ({ id: item, group: 'strength', type: 'attribute' })),
                    ...uniqueInterests.map(item => ({ id: item, group: 'interest', type: 'attribute' })),
                    ...uniqueEducation.map(item => ({ id: item, group: 'education', type: 'attribute' })),
                    ...uniqueJobs.map(item => ({ id: item, group: 'job', type: 'job' }))
                ];
                
                // Create links array
                const linksArray = [];
                
                jsonData.forEach(entry => {
                    // Add links from strength to job
                    linksArray.push({
                        source: entry.Strength,
                        target: entry["Job Opportunity"],
                        type: 'strength-job'
                    });
                    
                    // Add links from interest to job
                    linksArray.push({
                        source: entry["Interest/Hobby"],
                        target: entry["Job Opportunity"],
                        type: 'interest-job'
                    });
                    
                    // Add links from education to job
                    linksArray.push({
                        source: entry["Educational Background"],
                        target: entry["Job Opportunity"],
                        type: 'education-job'
                    });
                });
                
                // Calculate connection counts for node sizing
                const connectionCounts = {};
                linksArray.forEach(link => {
                    if (!connectionCounts[link.source]) connectionCounts[link.source] = 0;
                    if (!connectionCounts[link.target]) connectionCounts[link.target] = 0;
                    
                    connectionCounts[link.source]++;
                    connectionCounts[link.target]++;
                });
                
                // Add connection count to nodes
                const nodesWithConnections = nodesArray.map(node => ({
                    ...node,
                    connections: connectionCounts[node.id] || 0
                }));
                
                setNodes(nodesWithConnections);
                setLinks(linksArray);
            };
            
            // Filter nodes and links based on selected categories
            const getFilteredNodesAndLinks = () => {
                if (!nodes.length || !links.length) return { filteredNodes: [], filteredLinks: [] };
                
                // Filter nodes by selected categories
                const filteredNodes = nodes.filter(node => {
                    if (node.type === 'job') return true;
                    if (node.group === 'strength' && selectedCategories.strength) return true;
                    if (node.group === 'interest' && selectedCategories.interest) return true;
                    if (node.group === 'education' && selectedCategories.education) return true;
                    return false;
                });
                
                // Get node IDs for filtering links
                const nodeIds = new Set(filteredNodes.map(n => n.id));
                
                // Filter links - only keep links where both source and target are in filtered nodes
                const filteredLinks = links.filter(link => {
                    // Check if both source and target exist in filtered nodes
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return nodeIds.has(sourceId) && nodeIds.has(targetId);
                });
                
                return { filteredNodes, filteredLinks };
            };
            
            // Retrieve job details
            const getJobDetails = (jobId) => {
                if (!data) return null;
                
                // Find all entries for this job
                const jobEntries = data.filter(item => item["Job Opportunity"] === jobId);
                
                if (jobEntries.length === 0) return null;
                
                // Extract unique values for each attribute
                const workModes = [...new Set(jobEntries.map(item => item["Work Mode"]))];
                const salaryRanges = [...new Set(jobEntries.map(item => item["Salary Range"]))];
                const strengths = [...new Set(jobEntries.map(item => item["Strength"]))];
                const interests = [...new Set(jobEntries.map(item => item["Interest/Hobby"]))];
                const education = [...new Set(jobEntries.map(item => item["Educational Background"]))];
                const sourceLinks = [...new Set(jobEntries.map(item => item["Source Link"]))];
                const industries = [...new Set(jobEntries.map(item => item["Industry"]))];
                
                return {
                    jobTitle: jobId,
                    workModes,
                    salaryRanges,
                    strengths,
                    interests,
                    education,
                    sourceLinks,
                    industries
                };
            };
            
            // Toggle section expansion
            const toggleSection = (section) => {
                setExpandedSections(prev => ({
                    ...prev,
                    [section]: !prev[section]
                }));
            };
            
            // Handle node click
            const handleNodeClick = (node) => {
                if (node.group === 'job') {
                    setSelectedJobDetails(getJobDetails(node.id));
                }
            };
            
            // Toggle category filters
            const toggleCategory = (category) => {
                setSelectedCategories(prev => ({
                    ...prev,
                    [category]: !prev[category]
                }));
            };
            
            // Initialize and update D3 visualization
            React.useEffect(() => {
                if (loading || !nodes.length || !links.length) return;
                
                const { filteredNodes, filteredLinks } = getFilteredNodesAndLinks();
                
                if (!filteredNodes.length) return;
                
                // Clear previous visualization
                d3.select(svgRef.current).selectAll("*").remove();
                
                // Stop previous simulation
                if (simulationRef.current) simulationRef.current.stop();
                
                // Create SVG container
                const svg = d3.select(svgRef.current)
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height]);
                    
                // Create a zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([0.5, 5])
                    .on("zoom", (event) => {
                        g.attr("transform", event.transform);
                    });
                
                svg.call(zoom);
                
                // Create a group for the network
                const g = svg.append("g");
                
                // Define color scale
                const colorScale = d3.scaleOrdinal()
                    .domain(['strength', 'interest', 'education', 'job'])
                    .range(['#4CAF50', '#2196F3', '#FFC107', '#F44336']);
                
                // Define simulation
                const simulation = d3.forceSimulation(filteredNodes)
                    .force("link", d3.forceLink(filteredLinks).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => Math.min(nodeRadius + d.connections * 0.5, 20)));
                
                simulationRef.current = simulation;
                
                // Create links
                const link = g.append("g")
                    .attr("stroke", "#999")
                    .attr("stroke-opacity", 0.6)
                    .selectAll("line")
                    .data(filteredLinks)
                    .join("line")
                    .attr("stroke-width", d => Math.sqrt(d.value || 1));
                
                // Create nodes
                const node = g.append("g")
                    .selectAll("circle")
                    .data(filteredNodes)
                    .join("circle")
                    .attr("r", d => Math.max(nodeRadius, Math.min(nodeRadius + d.connections * 0.5, 20)))
                    .attr("fill", d => colorScale(d.group))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .style("cursor", "pointer")
                    .on("click", (event, d) => handleNodeClick(d))
                    .call(drag(simulation));
                    
                // Add tooltips
                node.append("title")
                    .text(d => `${d.id} (${d.group})`);
                
                // Add text labels
                const text = g.append("g")
                    .selectAll("text")
                    .data(filteredNodes)
                    .join("text")
                    .attr("dx", 12)
                    .attr("dy", ".35em")
                    .text(d => d.id)
                    .style("font-size", "8px")
                    .style("pointer-events", "none");
                
                // Update positions on simulation tick
                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);
                        
                    node
                        .attr("cx", d => d.x = Math.max(nodeRadius, Math.min(width - nodeRadius, d.x)))
                        .attr("cy", d => d.y = Math.max(nodeRadius, Math.min(height - nodeRadius, d.y)));
                        
                    text
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });
                
                // Drag functions
                function drag(simulation) {
                    function dragstarted(event) {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        event.subject.fx = event.subject.x;
                        event.subject.fy = event.subject.y;
                    }
                    
                    function dragged(event) {
                        event.subject.fx = event.x;
                        event.subject.fy = event.y;
                    }
                    
                    function dragended(event) {
                        if (!event.active) simulation.alphaTarget(0);
                        event.subject.fx = null;
                        event.subject.fy = null;
                    }
                    
                    return d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended);
                }
                
                // Clean up
                return () => {
                    simulation.stop();
                };
            }, [nodes, links, selectedCategories, loading]);
            
            // Section Header Component with toggle functionality
            const SectionHeader = ({ title, section, expandedSections, toggleSection }) => (
                <div 
                    className="flex items-center justify-between cursor-pointer p-2 bg-gray-100 rounded mb-2"
                    onClick={() => toggleSection(section)}
                >
                    <h3 className="font-semibold">{title}</h3>
                    <span>{expandedSections[section] ? '▼' : '►'}</span>
                </div>
            );
            
            // AttributeList Component for displaying lists of attributes with color coding
            const AttributeList = ({ items, color, expanded }) => {
                if (!expanded) return null;
                
                return (
                    <div className="mb-3">
                        {items.length > 0 ? (
                            <div className="flex flex-wrap">
                                {items.map((item, index) => (
                                    <span 
                                        key={index} 
                                        className="attribute-tag" 
                                        style={{ backgroundColor: `${color}20`, color: color, border: `1px solid ${color}` }}
                                    >
                                        {item}
                                    </span>
                                ))}
                            </div>
                        ) : (
                            <p className="text-gray-500">No data available</p>
                        )}
                    </div>
                );
            };
            
            // Show loading indicator
            if (loading) {
                return <div className="w-full h-full flex items-center justify-center">Loading data...</div>;
            }
            
            // Show error message
            if (error) {
                return <div className="w-full h-full flex items-center justify-center text-red-500">{error}</div>;
            }
            
            return (
                <div className="w-full h-full flex flex-col p-4">
                    <div className="flex flex-col mb-4">
                        <h1 className="text-2xl font-bold mb-4">Job Network Visualization</h1>
                        
                        {/* Category filters */}
                        <div className="flex flex-wrap gap-4 mb-4">
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="strength"
                                    checked={selectedCategories.strength}
                                    onChange={() => toggleCategory('strength')}
                                    className="mr-2"
                                />
                                <label htmlFor="strength" className="flex items-center">
                                    <span className="w-4 h-4 inline-block bg-green-500 mr-2"></span>
                                    Strengths
                                </label>
                            </div>
                            
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="interest"
                                    checked={selectedCategories.interest}
                                    onChange={() => toggleCategory('interest')}
                                    className="mr-2"
                                />
                                <label htmlFor="interest" className="flex items-center">
                                    <span className="w-4 h-4 inline-block bg-blue-500 mr-2"></span>
                                    Interests/Hobbies
                                </label>
                            </div>
                            
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="education"
                                    checked={selectedCategories.education}
                                    onChange={() => toggleCategory('education')}
                                    className="mr-2"
                                />
                                <label htmlFor="education" className="flex items-center">
                                    <span className="w-4 h-4 inline-block bg-yellow-500 mr-2"></span>
                                    Education
                                </label>
                            </div>
                        </div>
                        
                        {/* Legend */}
                        <div className="flex flex-wrap gap-4 mb-4">
                            <div className="flex items-center">
                                <span className="w-4 h-4 inline-block bg-red-500 mr-2"></span>
                                <span>Job Opportunities</span>
                            </div>
                            <div className="text-sm text-gray-500">
                                * Node size indicates number of connections
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex flex-1 gap-4">
                        {/* Visualization area */}
                        <div className="flex-1 border rounded-lg overflow-hidden bg-gray-50">
                            <svg ref={svgRef} width="100%" height="100%"></svg>
                        </div>
                        
                        {/* Enhanced Job details panel */}
                        <div className="w-80 border rounded-lg p-4 bg-white overflow-hidden">
                            <h2 className="text-lg font-bold mb-4">Job Details</h2>
                            
                            {selectedJobDetails ? (
                                <div className="details-container">
                                    <h3 className="font-bold text-red-500 text-xl mb-3">{selectedJobDetails.jobTitle}</h3>
                                    
                                    {/* Industry Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Industry" 
                                            section="industry" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        {expandedSections.industry && (
                                            <AttributeList 
                                                items={selectedJobDetails.industries} 
                                                color="#9C27B0" 
                                                expanded={true} 
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Work Mode Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Work Modes" 
                                            section="workMode" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        {expandedSections.workMode && (
                                            <AttributeList 
                                                items={selectedJobDetails.workModes} 
                                                color="#607D8B" 
                                                expanded={true} 
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Salary Range Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Salary Ranges" 
                                            section="salary" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        {expandedSections.salary && (
                                            <AttributeList 
                                                items={selectedJobDetails.salaryRanges} 
                                                color="#FF9800" 
                                                expanded={true} 
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Strengths Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Required Strengths" 
                                            section="strengths" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        <AttributeList 
                                            items={selectedJobDetails.strengths} 
                                            color="#4CAF50" 
                                            expanded={expandedSections.strengths} 
                                        />
                                    </div>
                                    
                                    {/* Interests Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Related Interests/Hobbies" 
                                            section="interests" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        <AttributeList 
                                            items={selectedJobDetails.interests} 
                                            color="#2196F3" 
                                            expanded={expandedSections.interests} 
                                        />
                                    </div>
                                    
                                    {/* Education Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Educational Background" 
                                            section="education" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        <AttributeList 
                                            items={selectedJobDetails.education} 
                                            color="#FFC107" 
                                            expanded={expandedSections.education} 
                                        />
                                    </div>
                                    
                                    {/* Source Links Section */}
                                    <div className="mb-4">
                                        <SectionHeader 
                                            title="Source Links" 
                                            section="sourceLinks" 
                                            expandedSections={expandedSections} 
                                            toggleSection={toggleSection} 
                                        />
                                        {expandedSections.sourceLinks && (
                                            <div className="pl-2">
                                                {selectedJobDetails.sourceLinks.map((link, index) => (
                                                    <div key={index} className="mb-1">
                                                        <a 
                                                            href={link} 
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-blue-500 hover:underline"
                                                        >
                                                            Source {index + 1}
                                                        </a>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <p className="text-gray-500">Click on a job node (red) to view details.</p>
                            )}
                        </div>
                    </div>
                    
                    <div className="mt-4 text-sm text-gray-600">
                        <p>Instructions:</p>
                        <ul className="list-disc pl-5">
                            <li>Select categories using checkboxes above</li>
                            <li>Drag nodes to reposition</li>
                            <li>Click on a job node (red) to view details</li>
                            <li>Click section headers in job details to expand/collapse</li>
                            <li>Scroll to zoom in/out</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // Render the application
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<JobNetworkVisualization />);
    </script>
</body>
</html>
